---
import Header from '../components/Header.astro';
import Layout from '../layouts/Layout.astro';
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

const logoutAndRedirect = () => {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/");
};

if (!accessToken || !refreshToken) {
  return Astro.redirect("/");
}

let session;
try {
    const { data, error } = await supabase.auth.setSession({
        refresh_token: refreshToken.value,
        access_token: accessToken.value,
    });
    if (error) {
        throw error;
    }
	session = data.session;

} catch (error) {
    return logoutAndRedirect();
}

const email = session?.user?.email || '';
const userId = session?.user?.id || '';

const { data: userFiles, error } = await supabase.from('license').select('product_name, status, file_url, created_at')
    .eq('user_id', userId).order('created_at', { ascending: false });

const files = userFiles || [];


//downloadUrl: `${supabase.storage.from('your_bucket_name').getPublicUrl(`${userId}/${file.name}`).data.publicUrl}?download`,

---

<Layout>

	<div class="container">
		<Header email={email}/>
		<div class="content">
			<section class="request-section">
                <h2>¿Necesitas una nueva licencia?</h2>
                <p>Haz clic en el botón para solicitar una nueva licencia.</p>
                <a href="/license" class="request-button">
                    Solicitar Licencia
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </a>
            </section>
			<section class="files-table-container">
                <h2>Mis Archivos</h2>
                <table class="files-table">
                    <thead>
                        <tr>
                            <th>Nombre del Archivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {files.map(file => (
                            <tr>
                                <td>
									<label class="md:hidden">Nombre:</label>
									<span>{file.product_name}</span>
								</td>
                                <td class={`status-${file.status}`}>
                                    <label class="md:hidden">Estado</label>
									{file.status === true ? 'Listo' : 'Procesando...'}
                                </td>
                                <td>
                                    {file.status ? (
										<label class="md:hidden">Archivo</label>
                                        <a href={file.file_url} class="download-button" download>
                                            Descargar
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>
                                        </a>
                                    ) : (
                                        <span>Licencia no disponible</span>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </section>

		</div>
	</div>
</Layout>

<style>
	.container {
		max-width: 800px;
		margin: 0 auto;
		padding: 20px;
		font-family: Arial, sans-serif;
	}

	.content {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	/* --- Estilos para la sección de solicitud --- */
    .request-section {
        background-color: #f0f4f8;
        padding: 1rem;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .request-section h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: #1a237e;
    }
    .request-section p {
		font-size: 0.8rem;
        color: #555;
        margin-bottom: 0.7rem;
    }
    .request-button {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background-color: #4a90e2;
        color: white;
		padding: 0.5rem 1rem;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .request-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
	/* --- Estilos para la tabla de archivos --- */
    .files-table-container {
        background-color: white;
        padding: 1rem;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .files-table-container h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: #1a237e;
    }
    .files-table {
        width: 100%;
        border-collapse: collapse;
    }
    .files-table th, .files-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    .files-table th {
        background-color: #f9f9f9;
        font-weight: 600;
        color: #444;
    }
    .status-false {
        color: #ff9800;
        font-weight: 600;
    }
    .status-true {
        color: #4caf50;
        font-weight: 600;
    }
    .download-button {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background-color: #4caf50;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 0.9em;
        transition: background-color 0.2s;
    }
    .download-button:hover {
        background-color: #43a047;
    }
    .download-button svg {
        width: 18px;
        height: 18px;
    }
	/* Estilos para las filas de la tabla en móvil */
	thead{
		display: none;
	}
	
    .files-table tbody, .files-table tr {
        display: block;
        width: 100%;
    }
	
    .files-table tr {
        margin-bottom: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 15px;
        box-sizing: border-box;
    }

    /* Estilos para las celdas de la tabla en móvil */
    .files-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding: 10px 0;
        text-align: right;
    }

    /* --- Media Query para pantallas grandes (escritorio) --- */
    @media (min-width: 768px) {
        .files-table thead {
            display: table-header-group;
        }

        .files-table tbody, .files-table tr {
            display: table-row-group;
        }

        .files-table tr {
            display: table-row;
            margin-bottom: 0;
            background-color: transparent;
            box-shadow: none;
            padding: 0;
        }

        .files-table td {
            display: table-cell;
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
    }

</style>