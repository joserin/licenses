---
import Layout from '../layouts/Layout.astro';
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

const logoutAndRedirect = () => {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/");
};

if (!accessToken || !refreshToken) {
  return Astro.redirect("/");
}

let session;
try {
    const { data, error } = await supabase.auth.setSession({
        refresh_token: refreshToken.value,
        access_token: accessToken.value,
    });
    if (error) {
        throw error;
    }
    session = data.session;

} catch (error) {
    return logoutAndRedirect();
}


const response = await fetch('http://localhost:4321/api/licenses/request-fingerprint');
const data = await response.json();
const fingerprint = data.fingerprint;
console.log(session)
---

<Layout>

	<h1>Mi Fingerprint</h1>
	<p>El fingerprint de la m√°quina es:</p>
	<pre>{fingerprint}</pre>
	
</Layout>
