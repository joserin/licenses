---
import Header from '../components/Header.astro';
import Layout from '../layouts/Layout.astro';
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

const logoutAndRedirect = () => {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/");
};

if (!accessToken || !refreshToken) {
  return Astro.redirect("/");
}

let session;
try {
    const { data, error } = await supabase.auth.setSession({
        refresh_token: refreshToken.value,
        access_token: accessToken.value,
    });
    if (error) {
        throw error;
    }
	session = data.session;

} catch (error) {
    return logoutAndRedirect();
}

const email = session?.user?.email || '';
---
<Layout>

    <div class="container">
        <Header email={email}/>

        <main class="content">
            <div class="confirmation-container">
                <h2>Informacion enviado con éxito!</h2>
                <span class="text-sm">Gracias por enviar la información. Hemos recibido tu solicitud.</span>
                <p>
                Nuestro equipo la verificará y, si todo está correcto, te enviaremos el
                archivo solicitado a tu correo electrónico en un plazo de <strong>1 a 2
                horas hábiles.</strong>
                </p>
                <span class="text-sm">Por favor, revisa tu bandeja de entrada (y la carpeta de spam) regularmente.</span>
                <a href="/home" class="home-btn">Regresar al inicio</a>
            </div>
        </main>

    </div>
    

</Layout>

<style>
    .container {
		max-width: 800px;
		margin: 0 auto;
		padding: 20px;
		font-family: Arial, sans-serif;
	}
    .content {
		display: grid;
		gap: 30px;
	}
    .confirmation-container {
        max-width: 600px;
        margin: 1rem auto;
        padding: 2rem;
        text-align: center;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    h2 {
        color: #2c3e50;
        font-size: 1.8rem;
        margin-bottom: 1rem;
    }

    p {
        color: #555;
        font-size: 1rem;
        line-height: 1.6;
    }
    .home-btn {
		background-color: #007bff;
		color: white;
		border: none;
		padding: 12px 24px;
		border-radius: 4px;
		cursor: pointer;
		font-size: 16px;
		width: 100%;
	}

	.home-btn:hover {
		background-color: #0056b3;
	}
</style>